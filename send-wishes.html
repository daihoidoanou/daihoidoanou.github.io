<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta http-equiv="X-UA-Compatible" content="IE=edge" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>CHÀO MỪNG ĐẠI HỘI XI</title>
        <link rel="shortcut icon" href="./assets/img/LOG-XI.png" type="image/x-icon"/>
        <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.4.0/css/font-awesome.min.css">
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.1/dist/css/bootstrap.min.css">
        <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.slim.min.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.1/dist/js/bootstrap.bundle.min.js"></script>
        <script src="./js/main.js"></script>
        <style>
            body {
                max-width: 800px;
            }
            * {
                transition: all 0.5s ease;
            }
            .main-left__wrap-img:hover {
                cursor: pointer;
                opacity: 0.8;
            }
        </style>
    </head>
    <body class="container-fluid">
        <section class="row jumbotron bg-white">
            <div class="main-left col-6">
                <div class="main-left__wrap" title="Tải lên hình ảnh của bạn! Tỉ lệ 1:1">
                    <img style="border-radius: 50%; border: 1px solid var(--blue)" class="main-left__wrap-img" src="" alt="Picture" width="200px"/>
                    <div class="loading"><span></span></div>
                </div>
                <input class="main-left__inp" type="file" hidden />
            </div>
            <div class="main-right col-6">
                <form class="main-right__form">
                    <div class="main-right__form-group">
                        <div class="main-right__form-title label">
                            Thông điệp của bạn
                        </div>
                        <textarea required class="main-right__form-input form-control" name="" id="" cols="30" rows="10"></textarea>
                        <div class="main-right__form-count-char">
                            <span class="count-char__now">0</span>
                            /
                            <span class="count-char__max">400</span>
                        </div>
                    </div>
                    <div class="main-right__form-group">
                        <div class="main-right__form-title">Ký tên</div>
                        <input required type="text" class="main-right__form-input form-control"/>
                        <div class="main-right__form-count-char">
                            <span class="count-char__now">0</span>
                            /
                            <span class="count-char__max">40</span>
                        </div>
                    </div>
                    <button type="submit" class="main-right__form-submit-btn btn btn-primary form-control">Gửi thông điệp</button>
                </form>
            </div>
        </section>
        <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script>
        const app = (() => {
            const avtLS =
                JSON.parse(localStorage.getItem("avtLS")) ||
                "https://cdn4.iconfinder.com/data/icons/user-gradient-set-1/128/user_action_set_2-22-512.png";

            return {
                isLoading: false,
                handleEvent() {
                    const _this = this;
                    const inputs = $$(".main-right__form-input");
                    const mainLeftWrap = $(".main-left__wrap");
                    const loading = $(".main-left__wrap .loading");

                    mainLeftWrap.querySelector("img").src = avtLS;

                    inputs.forEach((input) => {
                        input.oninput = function (e) {
                            const span =
                                this.parentElement.querySelector(
                                    ".count-char__now"
                                );
                            const max = parseInt(
                                this.parentElement.querySelector(
                                    ".count-char__max"
                                ).innerHTML
                            );

                            const lengthInp = input.value.length;

                            if (lengthInp <= max) {
                                span.innerHTML = lengthInp;
                            } else {
                                this.blur();
                            }
                        };
                    });

                    mainLeftWrap.onclick = function () {
                        if (!_this.isLoading) {
                            this.parentElement
                                .querySelector(".main-left__inp")
                                .click();
                        }
                    };

                    // loading
                    startLoading = () => {
                        _this.isLoading = true;
                        loading.classList.add("active");
                    };

                    endLoading = () => {
                        _this.isLoading = false;
                        loading.classList.remove("active");
                    };

                    $(".main-left__inp").onchange = (e) => {
                        startLoading();
                        const file = e.target.files[0];
                        if (file) {
                            const reader = new FileReader();
                            reader.readAsDataURL(file);
                            reader.onloadend = async () => {
                                await axios
                                    .post(
                                        "https://dai-hoi-xi.herokuapp.com/post/upload-avt",
                                        {
                                            data: reader.result,
                                        }
                                    )
                                    .then((res) => {
                                        localStorage.setItem(
                                            "avtLS",
                                            JSON.stringify(res.data)
                                        );
                                        mainLeftWrap.querySelector(
                                            "img"
                                        ).src = res.data;
                                    })
                                    .catch((err) => {
                                        console.log(err.response?.data);
                                    })
                                    .finally(() => {
                                        setTimeout(endLoading, 2000);
                                    });
                            };
                        }
                    };

                    $(".main-right__form-submit-btn").onclick = async (
                        e
                    ) => {
                        e.preventDefault();
                        const avt = mainLeftWrap.querySelector("img").src;
                        const content = inputs[0].value;
                        const name = inputs[1].value;
                        if (avt && name && content) {
                            const data = {
                                avt,
                                name,
                                content,
                            };

                            await axios
                                .post(
                                    "https://dai-hoi-xi.herokuapp.com/post/new-post",
                                    data
                                )
                                .then((res) => {
                                    inputs[0].value = null;
                                    inputs[1].value = null;
                                    window.location.href = "./index.html";
                                })
                                .catch((err) =>
                                    console.log(err.response?.data)
                                );
                        }
                    };
                },
                start() {
                    this.handleEvent();
                },
            };
        })().start();
    </script>
    </body>
</html>
